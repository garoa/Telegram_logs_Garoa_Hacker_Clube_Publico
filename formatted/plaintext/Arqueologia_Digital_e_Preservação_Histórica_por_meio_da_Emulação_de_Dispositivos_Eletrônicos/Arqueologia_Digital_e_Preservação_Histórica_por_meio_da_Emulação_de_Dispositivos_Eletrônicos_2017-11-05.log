[2017-11-05 00:02:09] Werner Eck: https://github.com/ppeccin/javatari.js
[2017-11-05 00:02:30] Felipe "Juca" Sanches: Esse cara fez emulador de MSX tamb√©m, se n√£o me engano
[2017-11-05 00:02:54] Werner Eck: sim
[2017-11-05 00:03:13] Werner Eck: https://github.com/ppeccin/WebMSX
[2017-11-05 00:03:21] Felipe "Juca" Sanches: exato!
[2017-11-05 00:31:56] Felipe "Juca" Sanches: Esse trecho de c√≥digo aqui logo no in√≠cio do boot do sagitta180 (rom do 150) preenche a regi√£o de 0x8000 at√© 0x8fff (4kbytes) com o valor 0x20 (caractere espa√ßo):
[2017-11-05 00:32:04] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804726048_39811.jpg
[2017-11-05 00:32:43] Felipe "Juca" Sanches: s√≥ n√£o entendo pra que ele usa o contador no registrador C com o valor 2, que faz ele executar a escrita duas vezes
[2017-11-05 00:33:33] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804722809_61130.jpg
[2017-11-05 00:35:04] Werner Eck: vc j√° conseguiu parsear a rom pra conseguir obter j√° os opcodes e operandos separadamente?
[2017-11-05 00:35:27] Werner Eck: ah j√° deve ter emula√ß√£o da CPU 8080 pronta no MAME n√©?
[2017-11-05 00:35:33] Felipe "Juca" Sanches: sim
[2017-11-05 00:35:41] Werner Eck: vc n√£o precisou fazer essa parte
[2017-11-05 00:35:52] Felipe "Juca" Sanches: simplesmente instanciei o I8080 e carreguei a ROM nele
[2017-11-05 00:36:01] Felipe "Juca" Sanches: e j√° t√¥ com c√≥digo rodando
[2017-11-05 00:36:02] Werner Eck: certo, q nem no Zezinho
[2017-11-05 00:36:06] Felipe "Juca" Sanches: isso
[2017-11-05 00:36:12] Werner Eck: com tela e td?
[2017-11-05 00:36:32] Felipe "Juca" Sanches: s√≥ que no caso do zezinho a gente escreveu a emula√ß√£o da CPU. E nesse caso, usei um m√≥dulo de emula√ß√£o que o MAME j√° tinha
[2017-11-05 00:36:52] Werner Eck: tendi
[2017-11-05 00:37:03] Felipe "Juca" Sanches: instanciei tamb√©m o chip CRTC (gerador de v√≠deo) modelo I8275, da intel tamb√©m. Que o MAME tamb√©m emula
[2017-11-05 00:37:13] Felipe "Juca" Sanches: e declarei que tem uma tela com alguma resolu√ß√£o chutada
[2017-11-05 00:37:25] Werner Eck: onde ele decrementa esse registrador c?
[2017-11-05 00:37:33] Felipe "Juca" Sanches: come√ßando torto pra ir achando o caminho
[2017-11-05 00:37:44] Werner Eck: e ele t√° pegando direitinho a tela?
[2017-11-05 00:37:45] Felipe "Juca" Sanches: instru√ß√£o dcr c (decrement C register)
[2017-11-05 00:38:04] Werner Eck: ah vdd n√£o tinha visto ela
[2017-11-05 00:38:17] Felipe "Juca" Sanches: ent√£o... ainda t√° com a tela preta
[2017-11-05 00:38:24] Werner Eck: pq da√≠ ent√£o √© s√≥ vc setar um breakpoint nessa linha e ir acompanhando
[2017-11-05 00:38:34] Werner Eck: ele n√£o escreve nada?
[2017-11-05 00:38:46] Felipe "Juca" Sanches: eu botei uma ROM de CRTC de outro driver, por que a ROM do terminal eu ainda n√£o consegui fazer odump
[2017-11-05 00:38:52] Werner Eck: aaah
[2017-11-05 00:39:01] Werner Eck: pode ser q a√≠ esteja o cat's jump
[2017-11-05 00:39:19] Felipe "Juca" Sanches: a tela t√° preta por que o driver n√£o t√° correto. Mas a ROM do outro CRTC √© razo√°vel. Eu deveria ver algo.
[2017-11-05 00:39:43] Felipe "Juca" Sanches: o MAME tem um modo de visualiza√ß√£o de tiles que √© ativado pressionando F4
[2017-11-05 00:40:02] Werner Eck: e mesmo nesse modo, nada?
[2017-11-05 00:40:28] Werner Eck: vc n√£o conseguiria ver se ele est√° escrevendo os caracteres na mem√≥ria de v√≠deo?
[2017-11-05 00:40:31] Felipe "Juca" Sanches: e ele me mostra isso:
[2017-11-05 00:40:38] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_805512853_31540.jpg
[2017-11-05 00:40:49] Werner Eck: tipo qdo a gente visualizou a RAM do zezinho
[2017-11-05 00:41:07] Felipe "Juca" Sanches: sim, consigo. E ele est√° sim escrevendo a string l√°
[2017-11-05 00:41:11] Felipe "Juca" Sanches: deixa eu mostrar...
[2017-11-05 00:42:19] Felipe "Juca" Sanches: Logo depois de encher o buffer de v√≠deo com 0x20, o c√≥digo faz isso:
[2017-11-05 00:42:25] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804722650_63194.jpg
[2017-11-05 00:42:56] Felipe "Juca" Sanches: endere√ßo 78: carrega registrador HL com o valor 0776
[2017-11-05 00:43:10] Felipe "Juca" Sanches: endere√ßo 7B: carrega registrador DE com valor 8334
[2017-11-05 00:43:18] Felipe "Juca" Sanches: esses dois valores s√£o ponteiros para mem√≥ria
[2017-11-05 00:43:18] Werner Eck: da√≠ ele carrega o d, e entra numa esp√©cie de loop
[2017-11-05 00:43:23] Werner Eck: certo
[2017-11-05 00:43:44] Felipe "Juca" Sanches: o endere√ßo 8334 t√° dentro daquele bloco de VRAM (entre 8000 e 8fff)
[2017-11-05 00:43:45] Werner Eck: certo
[2017-11-05 00:43:59] Felipe "Juca" Sanches: ent√£o parece que √© onde ele vai escrever alguma coisa no v√≠deo
[2017-11-05 00:44:13] Felipe "Juca" Sanches: e o outro endere√ßo √© na ROM (0x0776)
[2017-11-05 00:44:19] Werner Eck: o q faz a instru√ß√£o stax?
[2017-11-05 00:44:41] Felipe "Juca" Sanches: inspecionando na janela de visualiza√ß√£o de conte√∫do da mem√≥ria, olha s√≥ o que tem l√° no endere√ßo 0776 da ROM:
[2017-11-05 00:45:12] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804722009_63906.jpg
[2017-11-05 00:45:55] Werner Eck: 0x0776 deveria √≠mprimir o 'S'
[2017-11-05 00:46:17] Felipe "Juca" Sanches: sim. S√≥ que esse c√≥digo a√≠ √© um loop
[2017-11-05 00:46:18] Werner Eck: e da√≠ segue incrementando
[2017-11-05 00:46:22] Felipe "Juca" Sanches: que executa 0x23 vezes
[2017-11-05 00:46:26] Werner Eck: eu notei
[2017-11-05 00:46:29] Felipe "Juca" Sanches: que √© o tamanho  da string
[2017-11-05 00:46:48] Felipe "Juca" Sanches: ent√£o ele vai incrementando os ponteiros e faendo a c√≥pia de um byte por vez da ROM para a VRAM
[2017-11-05 00:46:49] Werner Eck: certo, q ele carregou l√° no contador em 0x07f
[2017-11-05 00:47:17] Werner Eck: agora pergunto, vc v√™ esses valores sendo escritos na RAM?
[2017-11-05 00:47:26] Felipe "Juca" Sanches: compara com 0x23. Se for zero pula fora, senao continua
[2017-11-05 00:47:31] Felipe "Juca" Sanches: sim, vejo
[2017-11-05 00:48:30] Felipe "Juca" Sanches: depois de rodar o loop de escrita da string:
[2017-11-05 00:48:33] Werner Eck: e essa √°rea q est√° sendo preenchida com esses valores lidos da EPROM, √© correspondente no MAME, √† √°rea de vram?
[2017-11-05 00:48:36] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804721105_82131.jpg
[2017-11-05 00:49:04] Felipe "Juca" Sanches: pois √©... a√≠ √© que est√° o lance
[2017-11-05 00:49:16] Felipe "Juca" Sanches: eu nunca tinha lidado com esse CRTC da Intel
[2017-11-05 00:49:19] Werner Eck: a partir de 0x8334
[2017-11-05 00:49:36] Felipe "Juca" Sanches (in reply to Werner Eck): exatamante  !
[2017-11-05 00:49:52] Felipe "Juca" Sanches: ou seja, n√£o √© no topo do v√≠deo. Deve ficar um pouco mais pra baixo
[2017-11-05 00:50:03] Werner Eck: eu perguntei pq penso se a 'janela' de visualiza√ß√£o do CRT controller est√° alinhada com essa RAM a√≠
[2017-11-05 00:50:10] Felipe "Juca" Sanches: por que o v√≠deo come√ßa em 0x8000
[2017-11-05 00:50:30] Felipe "Juca" Sanches: aparentemente n√£o vemos nada ainda por que o CRTC n√£o est√° configurado corretamente
[2017-11-05 00:51:01] Werner Eck: ah certo, talvez ele precise de uma inicializa√ß√£o
[2017-11-05 00:51:08] Felipe "Juca" Sanches: uma coisa curiosa desse CRTC da Intel que eu nunca tinha visto antes √© que ele interfaceia com a RAM principal do sistema por meio de um mecanismo de DMA
[2017-11-05 00:51:12] Werner Eck: eu tbm n√£o conhe√ßo esse perif√©rico.
[2017-11-05 00:51:18] Werner Eck: teria q dar uma olhada no ds dele
[2017-11-05 00:51:21] Felipe "Juca" Sanches: olha o datasheet dele aqui: http://www.jbox.dk/rc702/hardware/intel-8275.pdf
[2017-11-05 00:51:54] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_805514103_31745.jpg
[2017-11-05 00:53:07] Felipe "Juca" Sanches: ent√£o, se entendi direito, o firmware pode configurar o CRTC pra usar alguma faixa de mem√≥ria arbitr√°ria como VRAM
[2017-11-05 00:53:56] Werner Eck: √© nessa √°rea do bloco de DMA control logic √© q est√° o pulo do gato
[2017-11-05 00:54:14] Werner Eck: eu to dando uma olhada no ds q vc me mandou
[2017-11-05 00:54:38] Felipe "Juca" Sanches: eu vi um trecho de c√≥digo de boot do terminal que √© MUITO suspeito e que acontece antes da rotina de limpar a tela com espa√ßos:
[2017-11-05 00:54:43] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804721454_81459.jpg
[2017-11-05 00:55:18] Felipe "Juca" Sanches: isso a√≠ escreve 0x8000 na porta 0x44 e depois escreve 0x8FFF na porta 0x45
[2017-11-05 00:55:55] Felipe "Juca" Sanches: parece ser a configura√ß√£o de faixa de endere√ßos da VRAM, ent√£o suponho que o CRTC esteja mapeado nas portas de I/O 0x44 e 0x45
[2017-11-05 00:56:43] Felipe "Juca" Sanches: por conta disso escrevi o seguinte no driver:
[2017-11-05 00:56:50] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804730778_37572.jpg
[2017-11-05 00:57:13] Felipe "Juca" Sanches: Mas n√£o funcionou
[2017-11-05 01:03:52] Werner Eck: d√° uma olhada a partir da pg 17 desse ds
[2017-11-05 01:06:07] Werner Eck: tbm isso aqui √≥:
[2017-11-05 01:06:11] Werner Eck sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804729789_40008.jpg
[2017-11-05 01:06:15] Felipe "Juca" Sanches: Eu acho que o problema √© o seguinte: o CRTC requisite uma opera√ß√£o de DMA para ler o conte√∫do da VRAM. Quem recebe esse pedido √© o chip controlador de DMA, o Intel 8257. Ele vai fazer a m√°gica dele e sinalizar de volta pro CRTC quando tiver terminado.
[2017-11-05 01:07:17] Felipe "Juca" Sanches: ent√£o tem 3 coisas que meu driver de emula√ß√£o precisa fazer direito simultaneamente: (A) mapear o CRTC nas portas de I/O corretas para que ele possa ser configurado pela CPU. Isso acho que j√° consegui sacar, por que parece √≥bvio que as portas s√£o 0x44 e 0x45.
[2017-11-05 01:07:34] Werner Eck: sim, seria o DRQ/DACK
[2017-11-05 01:07:43] Felipe "Juca" Sanches: (B) mapear o chip controlador de DMA nas portas corretas (esse eu ainda n√£o fiz)
[2017-11-05 01:08:00] Felipe "Juca" Sanches: e (C) interconectar os 2 chips por meio dos dinais DRQ e DACk
[2017-11-05 01:08:27] Werner Eck: pode ser q o 5 nem esteja sendo ativado ainda
[2017-11-05 01:08:30] Felipe "Juca" Sanches: eu to tentando fazer (C), mas n√£o sei se estou fazendo direito. Mas n√£o adianta nada se eu n√£o fizer (B) tamb√©m.
[2017-11-05 01:08:48] Felipe "Juca" Sanches: 5 ?
[2017-11-05 01:09:07] Werner Eck: tentei editar e nao deixou
[2017-11-05 01:09:09] Werner Eck: 8275
[2017-11-05 01:09:15] Felipe "Juca" Sanches: ah ok
[2017-11-05 01:09:41] Werner Eck: parece q o telegram tem problema qdo o texto tem mais de uma linha
[2017-11-05 01:09:51] Werner Eck: pra editar, o cursor n√£o sobe
[2017-11-05 01:10:01] Felipe "Juca" Sanches: os n√∫meros dos chips s√£o muito parecidos. Um √© 8275 o outro √© 8257. √â pra dar n√≥ na cabe√ßa. Prefiro me referir a eles como CRTC (o 75) e DMAC (o 57)
[2017-11-05 01:10:10] Werner Eck: certo
[2017-11-05 01:10:44] Werner Eck: eu penso q talvez o crtc nem esteja sendo ativado, pois seria ele quem deveria ler aquela janela de ram e sincronizar o display cm o conteudo
[2017-11-05 01:11:07] Werner Eck: vc n√£o teria como visualizar o status dos pinos dele ?
[2017-11-05 01:11:16] Werner Eck: n√£o sei se isso √© poss√≠vel
[2017-11-05 01:11:17] Felipe "Juca" Sanches: olhando no c√≥digo de boot vejo outros 2 endere√ßos de I/O sendo usados, ent√£o s√≥ pode ser a configura√ß√£o do DMAC:
[2017-11-05 01:11:25] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804727843_37870.jpg
[2017-11-05 01:11:33] Felipe "Juca" Sanches: nos endere√ßos 0x30 e 0x31
[2017-11-05 01:11:44] Felipe "Juca" Sanches: vou tentar mapear o DMAC nessas duas portas e ver no que d√°
[2017-11-05 01:12:02] Werner Eck: vai la
[2017-11-05 01:13:08] Felipe "Juca" Sanches: ficou assim agora:
[2017-11-05 01:13:14] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804730481_38687.jpg
[2017-11-05 01:13:35] Werner Eck: rodou j√°?
[2017-11-05 01:14:24] Felipe "Juca" Sanches: compilando e tentando rodar
[2017-11-05 01:17:26] Felipe "Juca" Sanches: ent√£o... nada ainda.
[2017-11-05 01:17:49] Felipe "Juca" Sanches: Estou um pouco confuso sobre o mecanismo de interconex√£o dos sinais de DMA request e ACK
[2017-11-05 01:18:11] Werner Eck: existe no debugger algum jeito de vc monitorar certos sinais q v√£o pro crtc em tempo real?
[2017-11-05 01:18:15] Felipe "Juca" Sanches: o MAME oferece algumas macros que parecem sugerir que h√° tipos distintos de requisi√ß√µes, para IO ou acesso de mem√≥ria
[2017-11-05 01:18:31] Felipe "Juca" Sanches: e tamb√©m parece que tem mais de um sinal de requisi√ß√£o poss√≠vel para requisi√ß√£o
[2017-11-05 01:18:36] Werner Eck: q nem a gente estava fazendo com o PC, ACC do zezinho?
[2017-11-05 01:18:54] Felipe "Juca" Sanches: seria prudente agora eu ler o datasheet do DMAC pra entender o que significam os 4 bytes que o firmware escreveu na configura√ß√£o
[2017-11-05 01:19:05] Werner Eck: acredito q sim
[2017-11-05 01:19:26] Felipe "Juca" Sanches (in reply to Felipe "Juca" Sanches): Esses valores aqui
[2017-11-05 01:20:39] Felipe "Juca" Sanches: ent√£o √© esse cara que temos que estudar agora: http://www.threedee.com/jcm/terak/docs/Intel%208257%20Programmable%20DMA%20Controller.pdf
[2017-11-05 01:21:12] Werner Eck: talvez esses 4 valores q ele joga no &0x30 seja algum handshake
[2017-11-05 01:21:45] Felipe "Juca" Sanches: os 4 valores s√£o a inicializa√ß√£o do DMAC
[2017-11-05 01:22:16] Felipe "Juca" Sanches: eles devem especificar, por exemplo, as prioridades de tratamento dos pedidos de transferencia
[2017-11-05 01:24:06] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804729151_40381.jpg
[2017-11-05 01:24:19] Werner Eck: tava pra te mandar isso!
[2017-11-05 01:24:22] Werner Eck: exatamente isso
[2017-11-05 01:24:33] Felipe "Juca" Sanches: Essa descri√ß√£o do DMAC me faz acreditar que talvez os endere√ßos 0x8000 e 0x8FFF s√£o escritos no DMAC
[2017-11-05 01:24:36] Felipe "Juca" Sanches: e n√£o no CRTC
[2017-11-05 01:24:42] Werner Eck: dois registradores, um de endere√ßamento e outro de contagem
[2017-11-05 01:24:44] Felipe "Juca" Sanches: ent√£o vou inverter o mapeamento
[2017-11-05 01:25:15] Werner Eck: vc vai jogar o 8000 e 8fff no dma e o 30 e 31 no crtc?
[2017-11-05 01:25:16] Felipe "Juca" Sanches: por que aqueles valores dos endere√ßos 30 e 31 devem ser configura√ß√£o de resolu√ß√£o da tela e tamanho dos caracteres do CRTC
[2017-11-05 01:25:52] Werner Eck: de onde vc tirou isso?
[2017-11-05 01:26:30] Felipe "Juca" Sanches: vou trocar o mapeamento dos chips: botar DMAC nas portas de I/O 44 e 45 (que √© onde o firmware escreve 0x8000 e 0x8fff) e CRTC nas portas 30 e 31 (que √© onde ofw escreve aqueles outros valores)
[2017-11-05 01:26:37] Felipe "Juca" Sanches (in reply to Werner Eck): intui√ß√£o
[2017-11-05 01:26:42] Werner Eck: hahha
[2017-11-05 01:26:45] Werner Eck: entendi
[2017-11-05 01:27:03] Werner Eck (in reply to Felipe "Juca" Sanches): vdd
[2017-11-05 01:27:09] Werner Eck: tenta l√°
[2017-11-05 01:27:52] Felipe "Juca" Sanches: epa ! O bicho solu√ßou aqui hahaha
[2017-11-05 01:27:58] Werner Eck: opa!
[2017-11-05 01:28:02] Werner Eck: manda print ae
[2017-11-05 01:28:12] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804730735_38759.jpg
[2017-11-05 01:29:10] Werner Eck: umm, pode ser muita coisa
[2017-11-05 01:29:40] Werner Eck: pergunto ainda, se o crtc est√° sendo acionado corretamente
[2017-11-05 01:30:41] Felipe "Juca" Sanches: veja que o simbolo que se repete √© o s√≠mbolo n√∫mero zero
[2017-11-05 01:31:10] Felipe "Juca" Sanches (in reply to Felipe "Juca" Sanches): de acordo com essa visualiza√ß√£o dos tiles dispon√≠veis
[2017-11-05 01:31:47] Werner Eck: umm
[2017-11-05 01:32:33] Werner Eck: outra coisa, se o simbolo q aparece √© sempre repetido, ele tbm n√£o est√° incrementando o contador de caracteres
[2017-11-05 01:32:40] Werner Eck: √© o q parece
[2017-11-05 01:32:52] Felipe "Juca" Sanches: ou est√° lendo outra regi√£o da RAM
[2017-11-05 01:32:58] Felipe "Juca" Sanches: fora da faixa de VRAM
[2017-11-05 01:32:59] Werner Eck: ou isso
[2017-11-05 01:33:02] Felipe "Juca" Sanches: onde t√° tudo zero
[2017-11-05 01:33:10] Werner Eck: pode ser muita coisa
[2017-11-05 01:33:40] Werner Eck: suponhamos q eles dois estejam se falando direitinho agora, e a quest√£o seja mudar a janela
[2017-11-05 01:33:55] Werner Eck: seria o cen√°rio mais "f√°cil" de resolver
[2017-11-05 01:34:30] Werner Eck: mas eu novamente pergunto, como a gente sabe se ele est√° lendo a partir de outro endere√ßo qq?
[2017-11-05 01:34:42] Werner Eck: tem como visualizar isso no debugger?
[2017-11-05 01:35:01] Werner Eck: pq sen√£o vc vai ter q ir na tentativa e erro, mudando o valor do ender...
[2017-11-05 01:35:11] Werner Eck: vc mudou os valores que ele guardava nos registradores?
[2017-11-05 01:35:24] Werner Eck: vc inverteu os registradores dos dois chips
[2017-11-05 01:35:36] Werner Eck: e os valores 8000 e 8fff?
[2017-11-05 01:35:57] Felipe "Juca" Sanches: os valores 8000 e 8fff s√£o escritos no chip pelo firmware
[2017-11-05 01:36:01] Werner Eck: est√£o sendo armazenados em qual dos dois pares de registradores?
[2017-11-05 01:36:06] Felipe "Juca" Sanches: isso √© um fato. Nao tem que ser mudado
[2017-11-05 01:36:12] Werner Eck: t√°
[2017-11-05 01:36:23] Werner Eck: ent√£o...
[2017-11-05 01:36:51] Felipe "Juca" Sanches: vou voltar a ler o datasheet pra entender melhor o mecanismo de programa√ß√£o desses dois chips e interpretar os valores que o firmware escreve
[2017-11-05 01:37:05] Felipe "Juca" Sanches: por que o firmware est√° dizendo pra gente e a gente n√£o t√° querendo ler
[2017-11-05 01:37:31] Felipe "Juca" Sanches (in reply to Felipe "Juca" Sanches): a resposta est√° aqui. √â s√≥ interpretar o que significa com base no datasheet
[2017-11-05 01:38:28] Felipe "Juca" Sanches: E acabei de perceber que cortei errado essa imagem. Ficou faltando mostrar o primeiro valor que √© enviado para a porta 31
[2017-11-05 01:39:44] Felipe "Juca" Sanches: o valor √© zero, por que a instru√ß√£o logo antes de out 31 √© "XRA A" que, se n√£o me engano √© A <= A XOR A, que equivale a A=0
[2017-11-05 01:40:24] Werner Eck: eu to com uma suspeita
[2017-11-05 01:40:34] Felipe "Juca" Sanches: ent√£o a resposta tem que estar aqui:
[2017-11-05 01:40:39] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_805514450_32069.jpg
[2017-11-05 01:41:00] Werner Eck: de q esses 4 valores jogados no &30 possam estar inicializando os 4 modos de dma
[2017-11-05 01:43:04] Werner Eck: poderia ser ou o crtc jogando DRQ0~DRQ3 pro dma ou o dma jogando dack0~dack3 pro crtc
[2017-11-05 01:43:13] Werner Eck: eu to meio confuso
[2017-11-05 01:44:03] Felipe "Juca" Sanches: n√£o... esses valores a√≠ s√£o a inicializa√ß√£o do CRTC
[2017-11-05 01:44:09] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804727691_39789.jpg
[2017-11-05 01:44:41] Felipe "Juca" Sanches: a primeira escrita √© em 0x31 (bit A0=1) e o valor √© zero, ou seja, trata-se desse comando a√≠ da tabela acima, o comando de reset do CRTC
[2017-11-05 01:45:00] Felipe "Juca" Sanches: e os 4 bytes seguintes s√£o escritos em 0x30 (bit A0=0)
[2017-11-05 01:45:30] Felipe "Juca" Sanches: ent√£o o primeiro byte √© 4F = 0100 1111 = S H H H H H H H
[2017-11-05 01:45:45] Felipe "Juca" Sanches: ent√£o S=0 e H = 4f
[2017-11-05 01:46:17] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804721546_82071.jpg
[2017-11-05 01:47:03] Felipe "Juca" Sanches: S=0 significa "Normal Rows" (isso provavelmente significa que n√£o h√° 1 ou mais pixels de espa√ßamento entre os tiles)
[2017-11-05 01:47:56] Felipe "Juca" Sanches: e H=4f significa que temos 0x50 caracteres por linha
[2017-11-05 01:48:03] Felipe "Juca" Sanches: veja que soma 1 ao valor
[2017-11-05 01:48:18] Felipe "Juca" Sanches: 0x50 = 80 caracteres por linha
[2017-11-05 01:48:52] Felipe "Juca" Sanches: oras bolas... √© um terminal de 80 colunas :-)
[2017-11-05 01:49:30] Felipe "Juca" Sanches: veja, inclusive, na tabela acima, que 80 √© o maior valor permitido.
[2017-11-05 01:49:46] Felipe "Juca" Sanches: e t√° l√° justamente o nosso 4F na tabela
[2017-11-05 01:49:51] Werner Eck: e 4f=79
[2017-11-05 01:50:02] Werner Eck: 0x4f = 79d
[2017-11-05 01:50:02] Felipe "Juca" Sanches: ele soma 1 sempre
[2017-11-05 01:50:30] Felipe "Juca" Sanches: o valor zero significa 1 caractere por coluna e assim por diante. Veja de novo os valores da tabela
[2017-11-05 01:51:00] Felipe "Juca" Sanches: o chip interpreta a configura√ß√£o como (valor+1)
[2017-11-05 01:52:34] Felipe "Juca" Sanches: o segundo byte √© 0x59 = V V R R R R R R
[2017-11-05 01:52:54] Felipe "Juca" Sanches: 0x59 = 0101 1001
[2017-11-05 01:53:16] Felipe "Juca" Sanches: V = 1 e R = 25
[2017-11-05 01:53:18] Werner Eck (in reply to Felipe "Juca" Sanches): vc quer dizer, 1 char por linha?
[2017-11-05 01:53:41] Werner Eck: to tentando ler essa parte
[2017-11-05 01:54:23] Felipe "Juca" Sanches (in reply to Felipe "Juca" Sanches): ok... vamos olhar para a tabela de novo
[2017-11-05 01:55:38] Felipe "Juca" Sanches: caso esse par√¢metro tivesse recebido uma escrita do valor 0x00 = 0 0 0 0 0 0 0 0 , isso significaria 1 char por linha (que √© bizarro, mas parece que o chip suporta esses casos degenerados)
[2017-11-05 01:56:04] Felipe "Juca" Sanches: isso provavelmente seria um caractere grand√£o, esticad√£o na horizontal
[2017-11-05 01:56:15] Felipe "Juca" Sanches: pra um √∫nico caractere ser desenhado em uma linha inteira
[2017-11-05 01:56:31] Felipe "Juca" Sanches: mas o que o firmware do sagitta configura √© 4F
[2017-11-05 01:57:06] Felipe "Juca" Sanches: que √© o valor bin√°rio 1 0 0 1 1 1 1, que, apesar de em decimal valer 79, na tabela ele mostra que o chip interpreta como sendo 80 chars por linha
[2017-11-05 01:57:18] Werner Eck: e os outros valores, $59, $99, $ee?
[2017-11-05 01:57:29] Felipe "Juca" Sanches: ok... vamos pros outros 3 valores
[2017-11-05 01:57:46] Felipe "Juca" Sanches: o segundo valor √© 0x59 = 0 1 0 1 1 0 0 1
[2017-11-05 01:58:30] Felipe "Juca" Sanches: que segundo a tabela corresponde aos valores dos par√¢metros V V R R R R R R
[2017-11-05 01:58:45] Felipe "Juca" Sanches: V = 1 e R = 25
[2017-11-05 01:59:00] Felipe "Juca" Sanches: e o significado desses valores:
[2017-11-05 01:59:05] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804722079_62639.jpg
[2017-11-05 01:59:22] Werner Eck: s√£o esses parametros V e R q eu n√£o estou achando
[2017-11-05 01:59:38] Werner Eck: √© q vc deve estar com esse pdf em v√°rias abas
[2017-11-05 01:59:46] Felipe "Juca" Sanches: R = rows / frame
[2017-11-05 02:00:33] Felipe "Juca" Sanches: t√° na parte debaixo da p√°gina 17 (que √© identificada como p√°gina 8-239)
[2017-11-05 02:01:02] Werner Eck: acabei de me dar conta de q t√° td ali na msm pag, eu q comi bola
[2017-11-05 02:01:54] Werner Eck: Eu quero pensar q essa parte de inicializa√ß√£o do CRTC esteja funcionando
[2017-11-05 02:02:07] Felipe "Juca" Sanches: yep
[2017-11-05 02:02:11] Felipe "Juca" Sanches: parece tudo perfeito
[2017-11-05 02:02:23] Felipe "Juca" Sanches: por que esse valor R = 25 √© o que nos diz que a tela tem 25 linhas
[2017-11-05 02:02:30] Felipe "Juca" Sanches: ou seja √© um terminal em resolu√ß√£o 80x25
[2017-11-05 02:02:37] Felipe "Juca" Sanches: resolu√ß√£o bem t√≠pica
[2017-11-05 02:02:43] Werner Eck: uma coisa q me chamou a aten√ß√£o √© esse parametro M
[2017-11-05 02:03:35] Werner Eck: parece ser um offset para o contador de linhas. Mas pensando melhor, acho q nao tem nada a ver com nada
[2017-11-05 02:03:43] Werner Eck: entao, voltamos ao estado de...
[2017-11-05 02:03:58] Werner Eck: parece q a inicializa√ß√£o do CRTC se d√° ali mesmo
[2017-11-05 02:04:22] Werner Eck: talvez ent√£o, ele n√£o esteja lendo a √°rea certa?
[2017-11-05 02:05:25] Werner Eck: ou os caracteres lidos n√£o estejam sendo escritos na √°rea de VRAM q o CRTC espera? Mas se isso est√° codificado na EPROM, ent√£o √© l√° mesmo q tem q ser
[2017-11-05 02:06:08] Werner Eck: ser√° q estamos setando o CRTC para o range de endere√ßamento de VRAM certo?
[2017-11-05 02:09:01] Felipe "Juca" Sanches: eu acho que a transfer√™ncia DMA n√£o est√° acontecendo
[2017-11-05 02:09:21] Felipe "Juca" Sanches: por que o emulador n√£o est√° interligando corretamente os sinais entre o DMAC e o CRTC
[2017-11-05 02:09:43] Felipe "Juca" Sanches: e o efeito colateral √© que o CRTC √© inicializado, mas sua mem√≥ria interna tem um buffer todo cheio de zeros
[2017-11-05 02:09:58] Felipe "Juca" Sanches: e ele nunca consegue efetuar uma leitura via DMA
[2017-11-05 02:10:10] Felipe "Juca" Sanches: e portanto a gente continua vendo o caractere n√∫mero zero na tela inteira
[2017-11-05 02:10:38] Felipe "Juca" Sanches: acho que o ponto agora √© estudar o mecanismo de requisi√ß√£o e acknowledge de transfer√™ncia DMA
[2017-11-05 02:11:26] Felipe "Juca" Sanches: o endere√ßo inicial e final tamb√©m devem estar sendo configurados corretamente, pois j√° mapeei o DMAC nas portas 44 e 45 que √© onde o firmware escreve 8000 e 8fff que √© a faixa de endere√ßos da VRAM
[2017-11-05 02:12:09] Felipe "Juca" Sanches: acho que j√° matamos a xarada do mapeamento em I/O e o n√≥ est√° agora na emula√ß√£o da interconex√£o dos 2 chips.
[2017-11-05 02:13:20] Felipe "Juca" Sanches: tem um outro carinha na jogada que √© o Intel 8212
[2017-11-05 02:13:46] Felipe "Juca" Sanches: tem um desses na placa e o datasheet do DMAC diz que ele √© projetado pra trabalhar junto com um 8212
[2017-11-05 02:13:51] Werner Eck: ele existe no sagitta?
[2017-11-05 02:13:54] Felipe "Juca" Sanches: sim
[2017-11-05 02:14:03] Werner Eck: eu tava vendo isso no ds do crt
[2017-11-05 02:14:57] Werner Eck: veja na pg 2-112
[2017-11-05 02:15:49] Werner Eck: e depois pg 2-111, fig 8
[2017-11-05 02:19:00] Werner Eck: e o 8212 √© um latch de 8 bits
[2017-11-05 02:19:30] Werner Eck: se vc disse q tem ele na placa, teria q emular o bicho tbm
[2017-11-05 02:19:53] Werner Eck: ele deve estar entre o barramento de dados e o crtc
[2017-11-05 02:36:48] Felipe "Juca" Sanches: A configura√ß√£o do DMAController √© meio confusa no MAME. Olha um exemplo de um driver de outro computador que usa esse chip. Olha como ficam as macros:
[2017-11-05 02:36:54] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804727670_38379.jpg
[2017-11-05 02:37:06] Felipe "Juca" Sanches: Tenho que entender melhor a fun√ß√£o de cada sinal
[2017-11-05 02:37:14] Felipe "Juca" Sanches: pra n√£o ficar perdido
[2017-11-05 02:37:30] Felipe "Juca" Sanches: n√£o adianta chutar. O importante √© entender o que est√° acontecendo :-)
[2017-11-05 02:37:41] Felipe "Juca" Sanches: Vou dormir. Amanh√£ eu devo continuar nessa pesquisa
[2017-11-05 02:38:10] Felipe "Juca" Sanches: em √∫ltima inst√¢ncia, d√° pra ir l√° na USP com um mult√≠metro e verificar quais s√£o as interliga√ß√µes que foram feitas entre os chips
[2017-11-05 02:38:24] Felipe "Juca" Sanches: boa noite!
[2017-11-05 02:39:09] Werner Eck: boa noite!
[2017-11-05 02:48:25] Felipe "Juca" Sanches: uma observa√ß√£o, entretanto...
[2017-11-05 02:49:38] Felipe "Juca" Sanches: apesar de vermos os endere√ßos de I/O 44 e 45 sendo usados, o chip DMAC provavelmente est√° mapeado nas portas de 0x40 at√© 0x48
[2017-11-05 02:50:03] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804726878_39715.jpg
[2017-11-05 02:50:26] Felipe "Juca" Sanches: e o acesso a 44 e 45 √© a configura√ß√£o do canal n√∫mero 2
[2017-11-05 02:50:52] Felipe "Juca" Sanches: e, de fato tem uma escrita que o firmware faz no endere√ßo 0x48
[2017-11-05 02:50:56] Felipe "Juca" Sanches: eu tava comendo bola
[2017-11-05 02:51:20] Felipe "Juca" Sanches: vou mapear nesse range, por que assim a escrita em 0x48 vai setar o modo de opera√ß√£o da DMA
[2017-11-05 02:51:24] Felipe "Juca" Sanches: caramba... acho que √© isso
[2017-11-05 02:51:33] Werner Eck: quer tentar?
[2017-11-05 02:52:01] Felipe "Juca" Sanches: estou tentando
[2017-11-05 02:53:23] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804724205_56977.jpg
[2017-11-05 02:53:30] Felipe "Juca" Sanches: olha a escrita em 0x48 al√≠
[2017-11-05 02:53:39] Felipe "Juca" Sanches: t√° escrevendo o valor 0xC4
[2017-11-05 02:53:47] Felipe "Juca" Sanches: vamos ver o que √© esse valor ?
[2017-11-05 02:54:38] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804729055_39275.jpg
[2017-11-05 02:54:59] Werner Eck: acabei de chegar nisso
[2017-11-05 02:55:25] Felipe "Juca" Sanches: o valor 4 do n√∫mero 0xC4 s√£o aqueles 4 bits baixos de enable dos canais
[2017-11-05 02:55:30] Felipe "Juca" Sanches: 4 = 0 1 0 0
[2017-11-05 02:55:37] Felipe "Juca" Sanches: ou seja, todos os canais est√£o desabilitados
[2017-11-05 02:55:42] Felipe "Juca" Sanches: exceto o canal n√∫mero 2
[2017-11-05 02:55:43] Werner Eck: c4=11000100
[2017-11-05 02:56:46] Felipe "Juca" Sanches: isso √© a prova de que o sinal de DMA Request que o chip CRTC precisa enviar para o DMAC √© por meio do canal 2.
[2017-11-05 02:58:52] Felipe "Juca" Sanches: √â por isso que eu estou mantendo essa linha assim:
[2017-11-05 02:58:59] Felipe "Juca" Sanches sent document: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_5184080467493650480.png
[2017-11-05 02:59:33] Felipe "Juca" Sanches: MCFG_I8275_DRQ_CALLBACK(DEVWRITELINE("dma8257" , i8257_device , dreq2_w))
[2017-11-05 02:59:33] Werner Eck: dreq2
[2017-11-05 02:59:46] Werner Eck: write
[2017-11-05 03:00:37] Felipe "Juca" Sanches: dreq2_w √© o m√©todo do emulador do DMAC que voc√ä precisa chamar para sinalizar uma requisi√ß√£o de DMA para o canal #2
[2017-11-05 03:00:51] Werner Eck: entendi
[2017-11-05 03:00:58] Werner Eck: imaginei q seria isso
[2017-11-05 03:01:37] Felipe "Juca" Sanches: veja que essa macro configura que o DRQ emitido pelo CRTC chama um callback que sinaliza um dma request no canal 2 do DMAC
[2017-11-05 03:02:14] Felipe "Juca" Sanches: levou um tempinho at√© eu entender essa sintaxe
[2017-11-05 03:05:37] Werner Eck: agora sabemos q ele est√° setando o modo dma no canal 2, para isso o CRTC precisa requisitar nesse canal
[2017-11-05 03:05:46] Felipe "Juca" Sanches: sim
[2017-11-05 03:05:49] Felipe "Juca" Sanches: n√£o t√° funcionando ainda, mas foi bom eu ter tido essa sacada
[2017-11-05 03:06:09] Felipe "Juca" Sanches: se eu continuasse mapeando em 44 e 45 apenas, jamais iria funcionar
[2017-11-05 03:06:26] Felipe "Juca" Sanches: precisa mapear no intervalo todo, pra que o firmware consiga configurar o chip de DMA
[2017-11-05 03:06:30] Felipe "Juca" Sanches: na porta 48
[2017-11-05 03:07:02] Werner Eck: vdd
[2017-11-05 03:07:11] Werner Eck: bom, eu realmente preciso descansar
[2017-11-05 03:07:21] Werner Eck: j√° to vendo n√©voa na minha frente
[2017-11-05 03:07:38] Werner Eck: boa noite, vou nessa.
[2017-11-05 03:07:48] Felipe "Juca" Sanches: tem uns outros bandidos que s√£o as portas 0x21, 0x00 e 0x50
[2017-11-05 03:08:05] Felipe "Juca" Sanches: o firmware acessa esses outros endere√ßos logo no come√ßo
[2017-11-05 03:08:09] Felipe "Juca" Sanches: ent√£o a√≠ tem coisa tamb√©m
[2017-11-05 03:08:19] Felipe "Juca" Sanches: talvez seja o setup do chip de RS232
[2017-11-05 03:08:30] Werner Eck: amanh√£ podemos ver isso
[2017-11-05 03:08:38] Felipe "Juca" Sanches: beleza
[2017-11-05 03:08:45] Werner Eck: üëç
[2017-11-05 03:09:04] Felipe "Juca" Sanches: eu posso tamb√©m em algum momento dar um commit e subir pro meu github esse c√≥digo atual do driver pela metade
[2017-11-05 03:09:42] Felipe "Juca" Sanches: boa noite
[2017-11-05 03:09:43] Felipe "Juca" Sanches: e happy hacking!
[2017-11-05 03:44:56] Felipe "Juca" Sanches: BOOOM !!!!
[2017-11-05 03:45:02] Felipe "Juca" Sanches sent photo: /home/felipe/devel/github_garoa/Telegram_logs_Garoa_Hacker_Clube_Publico/media/Arqueologia_Digital_e_Preserva√ß√£o_Hist√≥rica_por_meio_da_Emula√ß√£o_de_Dispositivos_Eletr√¥nicos/download_804724025_59408.jpg
[2017-11-05 03:52:11] Felipe "Juca" Sanches: https://github.com/mamedev/mame/pull/2776
[2017-11-05 03:52:23] Felipe "Juca" Sanches: Agora sim! Agora posso ir dormir :-)
